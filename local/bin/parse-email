#!/usr/bin/zsh

LOGFILE=/data/homeassistant/email.log
BINFILE=/data/homeassistant/bin

SENDER=$(echo ${1}|tr -d '/'| sed "s#@#-a-#")
#SENDER="${1}"

cat << EOM >> ${LOGFILE}
==========
Received email from ${SENDER} at $(date +"%F %T")
EOM

case ${SENDER} in 
	*COUNCIL.gov.uk )
		TDIR=$(mktemp --directory --suffix=.pe)
		MASTER=${TDIR}/email.file.${SENDER}
		cat > ${MASTER}

		cat ${MASTER} | grep -q " POST CODE. Your "
		if [ ${?} -ne 0 ]; then
			# not a bin email, skip it
			cp ${MASTER} /tmp/email-$(date +%s).txt
			rm -rf ${TDIR}
			exit 0
		fi

		cp ${MASTER} /tmp/email.txt

		cat ${MASTER} | sed "1,/^$/d" | sed ':a;N;$!ba;s/=\n//g' | sed 's/<[^>]*>//g' | csplit -f ${TDIR}/xx - '/^----/' '{*}' >/dev/null 2>&1

		EMAIL_DATE=$(cat ${MASTER} | grep "X-Apparently-To" | sed "s/.*; //")
		WHAT=$(cat ${TDIR}/xx02 | grep "POST CODE" |  sed -e "s/.* POST CODE. Your //" -e "s/ .*//")
		WHEN=$(cat ${TDIR}/xx02 | grep "POST CODE" |  sed -e "s/.*be collected //" -e "s/\.\s.*$//" -e "s/\([0-9]\)[snrt][tdh]/\1/")
		case ${WHEN} in
			tomorrow* )	WHEN="$(date --date="tomorrow ${EMAIL_DATE}" +"%F 00:00:00")"
				;;
			* ) 	WHEN="$(echo "${WHEN}" | sed -e "s/^.*\([0-9]\)/\1" -e "s/\.$//")"
				# If this is December, and that's January, we need to add a year
				if [[ $(date +%m) -eq 12 && $(date --date="${WHEN}" +%m) -eq 01 ]]; then
					WHEN=$"(date --date="${WHEN} year" +"%F %T")"
				fi
				;;
		esac

		if [ -n "${WHAT}" ]; then
			cat <<-EOM >> ${BINFILE}.${WHAT:l}.json
			{ "collection_date":"${WHEN}", "collection_type":"${WHAT} Bin Collection","timestamp":"$(date +"%F %T")" }
			EOM
			cat <<-EOM >> ${LOGFILE}
			==========
			${WHAT} bin collection at ${WHEN} (parsed at $(date +"%F %T"))
			EOM
		else
			cp ${MASTER} /tmp/email-$(date +%s).txt
		fi
		;;
	* )	TDIR=$(mktemp --directory --suffix=.pe)
		MASTER=${TDIR}/email.file.${SENDER}
		cat > ${MASTER}
		cat << EOM >> ${LOGFILE}
==========
${SENDER}
-----
$(cat ${MASTER})
----------
EOM
		;;
esac

rm -rf ${TDIR}
